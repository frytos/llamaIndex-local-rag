---
phase: 02-api-security-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [config/Caddyfile, config/caddy-setup.sh, .env, rag_low_level_m1_16gb_verbose.py]
autonomous: false
user_setup:
  - service: domain-dns
    why: "HTTPS certificates require a domain pointing to your server"
    env_vars:
      - name: DOMAIN
        source: "Your domain name (e.g., rag.yourdomain.com)"
    account_setup:
      - url: "Your domain registrar (e.g., Namecheap, Cloudflare)"
        skip_if: "Already have a domain"
    dashboard_config:
      - task: "Point domain A record to server IP"
        location: "DNS management panel in your domain registrar"
        details: "Create A record: rag.yourdomain.com → [your-server-ip]"
    local_dev:
      - "For local testing: Use localhost without HTTPS (Caddy not needed locally)"
---

<objective>
Configure automatic HTTPS with Caddy reverse proxy and PostgreSQL SSL connections for transparent security layer.

Purpose: Enable secure access to RAG system with zero-config Let's Encrypt certificates, HTTP-to-HTTPS redirects, and encrypted database connections. Users experience seamless security without friction.

Output: Production-ready HTTPS setup with Caddy reverse proxy, security headers, and PostgreSQL SSL enforcement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-security-layer/02-CONTEXT.md
@.planning/phases/02-api-security-layer/02-RESEARCH.md
@.planning/phases/01-authentication-foundation/01-02-SUMMARY.md
@rag_web.py
@rag_low_level_m1_16gb_verbose.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Caddy configuration for automatic HTTPS</name>
  <files>config/Caddyfile, config/caddy-setup.sh</files>
  <action>
Create Caddyfile with automatic HTTPS configuration for Streamlit app:
- Domain placeholder {env.DOMAIN} for environment variable
- Reverse proxy to localhost:8501 (Streamlit default port)
- Security headers (HSTS, X-Frame-Options, CSP, etc.) following OWASP best practices
- Forward X-Real-IP and X-Forwarded-Proto headers to preserve client IP
- Enable gzip compression
- Caddy automatically handles Let's Encrypt certificate acquisition and renewal

Create caddy-setup.sh installation script:
- Detect OS (Ubuntu/Debian)
- Install Caddy from official repository
- Copy Caddyfile to /etc/caddy/Caddyfile
- Enable and start Caddy systemd service
- Verify ports 80 and 443 are accessible (critical for Let's Encrypt)

Use research code examples from 02-RESEARCH.md as reference for Caddyfile structure.
  </action>
  <verify>
- Caddyfile syntax is valid
- Setup script has executable permissions
- Script includes error handling for missing DOMAIN variable
  </verify>
  <done>
Caddyfile created with automatic HTTPS config, security headers, and reverse proxy to Streamlit. Setup script ready for deployment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PostgreSQL SSL configuration</name>
  <files>.env, rag_low_level_m1_16gb_verbose.py</files>
  <action>
Update .env file:
- Add PGSSLMODE=require (enforces SSL for database connections)
- Add STREAMLIT_SERVER_ADDRESS=localhost (bind Streamlit to localhost only, Caddy handles external access)
- Add STREAMLIT_SERVER_PORT=8501 (explicit port for Caddy reverse proxy)
- Add DOMAIN placeholder with example value

Update rag_low_level_m1_16gb_verbose.py database connection code:
- Find psycopg2.connect() calls
- Add sslmode parameter from environment variable: sslmode=os.getenv('PGSSLMODE', 'prefer')
- Add connection timeout: connect_timeout=10
- Verify SSL is enabled after connection with: SELECT ssl_is_used();

Do NOT change authentication logic or web UI code - Phase 1 authentication is complete and working.
  </action>
  <verify>
- .env contains PGSSLMODE=require
- Connection code includes sslmode parameter
- SSL verification query included
- Python imports os module if not already imported
  </verify>
  <done>
PostgreSQL connections configured to enforce SSL. Environment variables set for secure database access and Streamlit configuration.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure domain DNS and deploy Caddy</action>
  <instructions>
I've created the Caddy configuration and PostgreSQL SSL setup. To enable HTTPS, you need to:

1. **Set your domain in .env file**:
   ```bash
   DOMAIN=rag.yourdomain.com
   ```

2. **Point your domain's DNS A record to your server IP** (see user_setup in plan frontmatter)

3. **Deploy to your server and run the setup script**:
   ```bash
   # On your server (VPS/cloud instance)
   chmod +x config/caddy-setup.sh
   sudo config/caddy-setup.sh
   ```

4. **Ensure ports 80 and 443 are open** on your firewall/security groups (required for Let's Encrypt)

5. **Wait 30-60 seconds** for Let's Encrypt certificate acquisition

Caddy will automatically:
- Obtain Let's Encrypt certificate for your domain
- Redirect HTTP → HTTPS
- Renew certificates before expiration
- Serve your Streamlit app at https://rag.yourdomain.com
  </instructions>
  <verification>
After deployment, I can verify with:
- curl -I https://$DOMAIN returns 200 with HTTPS
- Caddy logs show successful certificate acquisition
- Streamlit app accessible via HTTPS
  </verification>
  <resume-signal>Type "deployed" when Caddy is running and domain is configured</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>HTTPS-enabled Streamlit RAG application with automatic Let's Encrypt certificates and security headers</what-built>
  <how-to-verify>
1. Visit https://your-domain.com (replace with your actual domain)
2. Verify browser shows padlock icon (trusted certificate, no warnings)
3. Test authentication: Login with credentials from Phase 1
4. Verify RAG functionality works: Try a test query
5. Check HTTP redirect: Visit http://your-domain.com - should redirect to HTTPS
6. Inspect security headers in browser DevTools → Network → Response Headers:
   - Strict-Transport-Security present
   - X-Frame-Options: DENY
   - X-Content-Type-Options: nosniff
7. Verify PostgreSQL SSL: Check server logs for SSL connection messages
  </how-to-verify>
  <resume-signal>Type "approved" if HTTPS works with no certificate warnings, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Caddy configuration file syntax is valid
- [ ] PostgreSQL SSL mode is set to require
- [ ] Domain configured and DNS resolves to server
- [ ] HTTPS accessible with valid Let's Encrypt certificate
- [ ] HTTP automatically redirects to HTTPS
- [ ] Security headers present in responses
- [ ] Streamlit app works behind Caddy reverse proxy
- [ ] Authentication from Phase 1 still works
- [ ] Database connections use SSL
</verification>

<success_criteria>
- Caddy installed and running with automatic HTTPS
- Let's Encrypt certificate obtained successfully
- Streamlit app accessible via HTTPS with no browser warnings
- HTTP-to-HTTPS redirect working
- Security headers applied to all responses
- PostgreSQL connections enforce SSL
- Zero friction for users (transparent security)
- Authentication from Phase 1 continues working
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-security-layer/02-01-SUMMARY.md`
</output>
