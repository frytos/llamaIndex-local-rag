name: Nightly Performance Benchmark

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:      # Manual trigger

jobs:
  comprehensive-benchmark:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need git history

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Create output directory
        run: |
          mkdir -p benchmarks/nightly/$(date +%Y%m%d)

      - name: Run comprehensive benchmark
        env:
          PERFORMANCE_RUN_TYPE: nightly
          BENCHMARK_MODE: comprehensive
          ENABLE_PERFORMANCE_RECORDING: 1
        run: |
          python scripts/run_comprehensive_benchmark.py \
            --output benchmarks/nightly/$(date +%Y%m%d)

      - name: Generate performance report
        run: |
          python scripts/generate_performance_report.py \
            --format html \
            --output benchmarks/nightly/$(date +%Y%m%d)/report.html

      - name: Generate markdown summary
        run: |
          python scripts/generate_performance_report.py \
            --format markdown \
            --output benchmarks/nightly/$(date +%Y%m%d)/summary.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-benchmark-${{ github.run_number }}
          path: |
            benchmarks/nightly/
            benchmarks/history/performance.db
          retention-days: 365

      - name: Check for significant regressions
        id: check_regression
        run: |
          if grep -q "⚠️.*REGRESSION" benchmarks/nightly/$(date +%Y%m%d)/summary.md; then
            echo "regression=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "regression=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue on regression
        if: steps.check_regression.outputs.regression == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            const summary = fs.readFileSync(`benchmarks/nightly/${date.replace(/-/g, '')}/summary.md`, 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Performance Regression Detected - ${date}`,
              body: `## Nightly Benchmark Regression\n\n${summary}\n\n**Action Required**: Please investigate the performance regression.\n\n[View Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['performance', 'regression', 'automated']
            });
